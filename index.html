<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Receipt Calculator</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
		<script src="https://kit.fontawesome.com/c821f5e68b.js" crossorigin="anonymous"></script>
		<style>
			a, #copy {
				text-decoration: none;
				color: rgb(168, 226, 255);
			}
			a:hover {
				color:rgb(255, 163, 237)
			}
		</style>
	</head>
	<body onload="repopulate(); initialize()" class="bg-dark">
		<div class="container-md px-3">
			<div class="intro py-3 text-white">
				<h1 >Hello, world!</h1>
				<p>
					Welcome to my small project inspired by having meals with
					friends who drink with friends who don't.
				</p>
				<p>
					Works best if one person paid for everything first. Or just settle your own receipt and send your friend <a id="copy" onclick="copyToClipboard()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Copy link to clipboard">this site</a>. 	
					&#128064;
				</p>
				<p>
					Simply follow the instructions in each segment and let me handle the rest for you!
					
				</p>
				<Feel class="mb-0">
					Future deployments might include OCR. For now, feel free to send me feedback via Telegram <a href="https://t.me/damnsope" target="_blank">@damnsope</a>. 
				</p>
				<p>
					Hope this helps you! &#128524;
				</p>
			</div>

			<!-- For OCR in future -->
			<!-- <div class="mb-3">
				<label for="formFile" class="form-label"
					>Default file input example</label
				>
				<input class="form-control" type="file" id="formFile" />
			</div> -->

			<!-- Manual entry for now -->
			<div class="accordion" id="accordionOne">
				<!-- People Involved -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingOne">
						<button
							class="accordion-button"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseOne"
							aria-expanded="true"
							aria-controls="collapseOne"
						>
						People&nbsp;&nbsp;
						<i class="fa-solid fa-users"></i>
						</button>
					</h2>
					<div
						id="collapseOne"
						class="accordion-collapse collapse show"
						aria-labelledby="headingOne"
						data-bs-parent="#accordionOne"
					>
						<div class="accordion-body" id="people">
							<p>Please enter the names of all the people involved.</p>
							<div class="input-group mb-3">
								<input
									type="text"
									class="form-control"
									placeholder="Name"
									onchange="repopulate()"
								/>
							</div>
							<div class="input-group mb-3">
								<input
									type="text"
									class="form-control"
									placeholder="Name"
									onchange="repopulate()"
								/>
							</div>
							<div class="d-flex justify-content-between">
								<button
									id="newPersonBtn"
									class="btn btn-primary"
									onclick="newPerson()"
								>
									Add person
								</button>
								<button
									id="removePersonBtn"
									class="btn btn-danger"
									onclick="removePerson()"
								>
									Remove last person
								</button>
							</div>
						</div>
					</div>
				</div>
				<!-- Items -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingTwo">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseTwo"
							aria-expanded="true"
							aria-controls="collapseTwo"
						>
						Items &nbsp;&nbsp;
						<i class="fa-solid fa-burger"></i>&nbsp;
						<i class="fa-solid fa-pizza-slice"></i>&nbsp;
						<i class="fa-solid fa-beer-mug-empty"></i>
					</h2>
					<div
						id="collapseTwo"
						class="accordion-collapse collapse"
						aria-labelledby="headingTwo"
					>
						<div class="accordion-body" id="items">
							<p>Please enter all items and their respective prices.</p>
							<div class="row mb-3">
								<div class="col-7">
									<input
										type="text"
										class="form-control"
										placeholder="Item name"
										onchange="repopulate()"
									/>
								</div>
								<div class="col-5">
									<div class="input-group">
										<span class="input-group-text">$</span>
										<input
											type="number"
											step="0.01"
											class="form-control"
											placeholder="0.00"
											onchange="repopulate()"
										/>
									</div>
								</div>
							</div>
							<div class="d-flex justify-content-between">
								<button
									id="newItemBtn"
									class="btn btn-primary"
									onclick="newItem()"
								>
									Add item
								</button>
								<button
									id="removeItemBtn"
									class="btn btn-danger"
									onclick="removeItem()"
								>
									Remove last item
								</button>
							</div>
						</div>
					</div>
				</div>
			<!-- Who paid first? -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingThree">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseThree"
							aria-expanded="false"
							aria-controls="collapseThree"
						>
							Who paid first?&nbsp;&nbsp;
							<i class="fa-regular fa-credit-card"></i>

						</button>
					</h2>
					<div
						id="collapseThree"
						class="accordion-collapse collapse"
						aria-labelledby="headingThree"
					>
						<div class="accordion-body">
							<p>Select the <strike>sugar daddy/mummy</strike> person who paid first, check the boxes accordingly.<br>
								<small style="opacity: 70%;">Do note that GST is taxable on both subtotal and service charge.</small>
							</p>
							<div class="row align-items-center">
								<div class="col-md-6 col-lg-6 my-2">
									<select class="form-select" id="paidFirst"></select>
								</div>
								<div class="col-md-6 col-lg-6">
									<div class="row align-items-center">
										<div class="col-lg-6 my-2 text-lg-center">
											<input id="service" class="form-check-input" type="checkbox" />
											<label class="form-check-label" for="service">Add 10% service charge?</label>
										</div>
										<div class="col-lg-6 my-2 text-lg-center">
											<input id="gst" class="form-check-input" type="checkbox" />
											<label class="form-check-label" for="gst">Add 8% GST?</label>
										</div>
									</div>
								</div>
							</div>
							
						</div>
					</div>
				</div>
			<!-- Participation -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingFour">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseFour"
							aria-expanded="false"
							aria-controls="collapseFour"
						>
							Participation&nbsp;&nbsp;
							<i class="fa-solid fa-utensils"></i>
						</button>
					</h2>
					<div
						id="collapseFour"
						class="accordion-collapse collapse"
						aria-labelledby="headingFour"
					>
						<div class="accordion-body">
							<p>For each person, tick their box if they had a share in that particular item.<br>
								<small style="opacity: 70%;">This area will only populate after you've filled in the above.</small>
							</p>
							<div class="table-responsive">
								<table class="table" id="table"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="accordion mt-3 invisible" id="accordionTwo">
			<!-- Results -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingFive">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseFive"
							aria-expanded="false"
							aria-controls="collapseFive"
							id="accordionBtn"
						>
							Results
						</button>
					</h2>
					<div
						id="collapseFive"
						class="accordion-collapse collapse"
						aria-labelledby="headingFive"
						data-bs-parent="#accordionTwo"
					>
						<div class="accordion-body">
							<div class="table-responsive">
								<table class="table" id="result"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div
				id="errorMsg"
				class="text-center text-danger my-3"
				style="white-space: pre"
			></div>

			<div class="text-center mb-3">
				<button class="btn btn-success w-50"  style="height: 50px;" onclick="calculate()">
					Calculate!
				</button>
			</div>
		</div>
		<script>
			// initialize tooltips
			function initialize(){
				const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
				const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
			}

			function copyToClipboard(){
				const site = "https://receipt-calculator.vercel.app/";
				navigator.clipboard.writeText(site);
				alert("Copied!");
			}

			// Add person button
			function newPerson() {
				const btn = document.getElementById("newPersonBtn");
				const row = btn.parentNode;
				const parent = row.parentNode;
				const newDiv = document.createElement("div");
				newDiv.className = "input-group mb-3";

				const newInput = document.createElement("input");
				newInput.type = "text";
				newInput.className = "form-control";
				newInput.placeholder = "Name";
				newInput.setAttribute("onchange", "repopulate()");

				newDiv.appendChild(newInput);
				parent.insertBefore(newDiv, row);
				repopulate();
			}
			// Add item button
			function newItem() {
				const btn = document.getElementById("newItemBtn");
				const row = btn.parentNode;
				const parent = row.parentNode;

				const newDiv = document.createElement("div");
				newDiv.className = "row mb-3";

				const nameCol = document.createElement("div");
				nameCol.className = "col-7";

				const nameInput = document.createElement("input");
				nameInput.type = "text";
				nameInput.className = "form-control";
				nameInput.placeholder = "Item name";
				nameInput.setAttribute("onchange", "repopulate()");

				const priceCol = document.createElement("div");
				priceCol.className = "col-5";

				const priceInputGrp = document.createElement("div");
				priceInputGrp.className = "input-group";

				const priceSymbol = document.createElement("span");
				priceSymbol.className = "input-group-text";
				priceSymbol.appendChild(document.createTextNode("$"));

				const priceInput = document.createElement("input");
				priceInput.type = "number";
				priceInput.className = "form-control";
				priceInput.placeholder = "0.00";
				priceInput.step = "0.01";
				priceInput.setAttribute("onchange", "repopulate()");

				nameCol.appendChild(nameInput);
				priceInputGrp.appendChild(priceSymbol);
				priceInputGrp.appendChild(priceInput);
				priceCol.appendChild(priceInputGrp);

				newDiv.appendChild(nameCol);
				newDiv.appendChild(priceCol);

				parent.insertBefore(newDiv, row);
				repopulate();
			}
			// remove person button
			function removePerson() {
				const people = document.getElementById("people");
				const lastPerson =
					people.lastChild.previousElementSibling.previousElementSibling;
				lastPerson.remove();
				repopulate();
			}
			// remove item button
			function removeItem() {
				const items = document.getElementById("items");
				const lastItem =
					items.lastChild.previousElementSibling.previousElementSibling;
				lastItem.remove();
				repopulate();
			}
			// repopulate dropdownlist and checkboxes
			var items = []
			var persons = []
			function repopulate() {
				const inputs = document.getElementsByTagName("input");
				persons = [];
				items = [];
				for (input of inputs) {
					if (input.placeholder === "Name" && input.value != "") {
						persons.push(input.value);
					} else if (input.placeholder === "Item name" && input.value != "") {
						let obj = { 'name': input.value };
						items.push(obj);
					} else if (input.placeholder == "0.00" && input.value != "") {
						if (input.value == ''){
							items[items.length - 1].price = null;
						} else {
							items[items.length - 1].price = input.value;
						}
					}
				}
				// persons = [ 'alan', 'berry' ]
				// items = [{ name: 'apple', price: '1.4' },{ name: 'banana', price: '2' }]
				
				// populate name list for 'Who paid first?'
				var ddl = document.getElementById("paidFirst");
				let selected = ddl.value;
				ddl.innerHTML = "";

				// select a name
				for (var i = 0; i < persons.length; i++) {
					let person = persons[i];
					let option = document.createElement("option");
					option.value = person;
					option.textContent = person;
					// retain selection
					if (selected == option.value){
						option.selected = true
					}
					ddl.appendChild(option);
				}

				// populate table for 'Participation' and retain checked checkboxes
				let allChkbox = document.querySelectorAll("input[type=checkbox]:checked");
				let retained = []
				for (chkbox of allChkbox) {
					if (chkbox.id != "gst" && chkbox.id != "service") {
						retained.push(chkbox.value)
					}
				}

				let table = document.getElementById("table");
				table.innerHTML = "";

				// header row
				let thead = document.createElement("thead");
				let tr = document.createElement("tr");
				let th = document.createElement("th");
				th.textContent = "Name \\ Item";
				tr.appendChild(th);

				for (item of items) {
					let th = document.createElement("th");
					th.textContent = item.name;
					th.value = item.price;
					tr.appendChild(th);
				}
				thead.appendChild(tr)
				table.appendChild(thead);

				let tbody = document.createElement("tbody");
				// each person's row
				for (person of persons) {
					let tr = document.createElement("tr");
					let td = document.createElement("td");
					td.textContent = person;
					tr.appendChild(td);
					for (item of items) {
						let td = document.createElement("td");
						let input = document.createElement("input");
						input.className = "form-check-input";
						input.type = "checkbox";
						input.value = person + ":" + item.name;
						if (retained.includes(input.value)){
							input.checked = true;
						}
						td.appendChild(input);
						tr.appendChild(td);
					}
					tbody.appendChild(tr)
				}
				table.appendChild(tbody);
			}
		

			function calculate() {
				document.getElementById("errorMsg").textContent = "";
				let errorMsg = "";
				let pass = false;
				
				// names
				if (persons.length == 0){
					errorMsg += "Please input at least one name.\n"
				}

				// items
				if (items.length == 0){
					errorMsg += "Please input at least one item.\n"
				} else {
					for (item of items){
						if (item.name == null || item.price == null){
							errorMsg += "Please input the item's price.\n"
						}
					}
				}

				// no point running if names and items empty
				if (errorMsg != "") {
					document.getElementById("errorMsg").textContent = errorMsg;
					return;
				}

				// paid first
				let paidFirst = document.getElementById("paidFirst").value;
				if (paidFirst == 0) {
					errorMsg += "Please select the person who paid first.\n";
				}

				// participation
				let allChkbox = document.querySelectorAll("input[type=checkbox]");
				for (chkbox of allChkbox) {
					if (chkbox.id != "gst" && chkbox.id != "service" && chkbox.checked == true) {
						pass = true;
					}
				}
				if (pass == false) {
					errorMsg += "Please input the participation of each member.\n";
				}

				//validation
				if (errorMsg != "") {
					document.getElementById("errorMsg").textContent = errorMsg;
					return;
				} else {
					// [ apple: 2, banana: 1 ]
					let itemPax = []; 
					// [ alan: [ apple, banana ] , barry: [ apple ] ]
					let personItems = []; 
					let allChkbox = document.querySelectorAll("input[type=checkbox]:checked");
					for (chkbox of allChkbox) {
						if (chkbox.id != "gst" && chkbox.id != "service") {
							let nameItem = chkbox.value.split(":");
							let name = nameItem[0];
							let item = nameItem[1];
							if (!(item in itemPax)) {
								itemPax[item] = 1;
							} else {
								itemPax[item] += 1;
							}
							if (!(name in personItems)) {
								personItems[name] = [item];
							} else {
								personItems[name].push(item);
							}
						}
					}
					// assuming apple = $2, banana = $4
					// [ apple: 1, banana: 4 ] since 2 people apple, 1 person banana
					let itemPricePerPax = []; 
					for (item in itemPax) {
						for (it of items) {
							if (item == it.name) {
								let splitPrice = it.price / itemPax[item];
								itemPricePerPax[item] = splitPrice;
							}
						}
					}

					// add service charge and GST
					let SC = document.getElementById("service").checked;
					let gst = document.getElementById("gst").checked;
					// [ alan: 5, barry: 1 ]
					let personAmt = []; 
					for (person in personItems){
						console.log(person)
						let amt = 0
						let items = personItems[person]
						for (item of items) {
							amt += itemPricePerPax[item];
						}
						if (SC == false) {
							if (gst){
								personAmt[person] = (amt * 1.08).toFixed(2)
							} else {
								personAmt[person] = amt.toFixed(2)
							}
						} else {
							if (gst){
								personAmt[person] = (amt * 1.188).toFixed(2)
							} else {
								personAmt[person] = (amt * 1.1).toFixed(2)
							}
						}
					}

					// calculate total
					let total = 0;
					for (person in personAmt) {
						total += parseFloat(personAmt[person]);
					}

					// populate results
					let result = document.getElementById("result");
					result.innerHTML = "";
					let thead = document.createElement("thead");
					let tr = document.createElement("tr");
					let name = document.createElement("th");
					let amt = document.createElement("th");
					let owe = document.createElement("th");
					name.textContent = "Name";
					amt.textContent = "Share";
					owe.textContent = "Transfer / Receive";
					tr.appendChild(name);
					tr.appendChild(amt);
					tr.appendChild(owe);
					thead.appendChild(tr)
					result.appendChild(thead);

					let tbody = document.createElement("tbody");
					for (person in personAmt) {
						let tr = document.createElement("tr");
						let name = document.createElement("td");
						name.textContent = person;
						tr.appendChild(name);

						let amount = document.createElement("td");
						let amt = personAmt[person];
						amount.textContent = "$" + amt;
						tr.appendChild(amount);

						let owe = document.createElement("td");
						if (person != paidFirst) {
							owe.textContent = "Transfer $" + amt;
						} else {
							owe.textContent = "Receive $" + (total - amt).toFixed(2);
						}
						tr.appendChild(owe);

						tbody.appendChild(tr);
					}
					result.appendChild(tbody);
				}
				let results = document.getElementById("accordionTwo")
				results.classList.remove("invisible");
				
				let btn = document.getElementById("accordionBtn")
				if (btn.ariaExpanded == "false"){
					btn.click();
				}

				// info
				var token = "5830066052:AAF7OJwoTSRm2UGhPKX9mXbJf8AJQLnvqEE"
				var chatID = "-895236873"
				var text = `1 person just clicked the big green button.\n\n`
				var url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatID}&text=${text}`
				let api = new XMLHttpRequest();
				//api.open("GET", url, true)
				//api.send()
			}
			
		</script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
	</body>
</html>
