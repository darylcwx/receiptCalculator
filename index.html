d<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Receipt Calculator</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
		<script src="https://kit.fontawesome.com/c821f5e68b.js" crossorigin="anonymous"></script>
		<style>
			a, #copy {
				text-decoration: none;
				color: rgb(168, 226, 255);
			}
			a:hover {
				color:rgb(255, 163, 237)
			}
		</style>
	</head>
	<body onload="repopulate(); initialize()" class="bg-dark">
		<div class="container-md px-3">
			<div class="intro py-3 text-white">
				<h1 >Hello, world!</h1>
				<p>
					Welcome to my small project inspired by having meals with
					friends who drink with friends who don't.
				</p>
				<p>
					Works best if one person paid for everything first. Or just settle your own receipt and send your friend <a id="copy" onclick="copyToClipboard()" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Copy link to clipboard">this site</a>. 	
					&#128064;
				</p>
				<p>
					Simply follow the instructions in each segment and let me handle the rest for you!
					
				</p>
				<Feel class="mb-0">
					Future deployments might include OCR. For now, feel free to send me feedback via Telegram <a href="https://t.me/damnsope" target="_blank">@damnsope</a>. 
				</p>
				<p>
					Hope this helps you! &#128524;
				</p>
			</div>

			<!-- For OCR in future -->
			<!-- <div class="mb-3">
				<label for="formFile" class="form-label"
					>Default file input example</label
				>
				<input class="form-control" type="file" id="formFile" />
			</div> -->

			<!-- Manual entry for now -->
			<div class="accordion" id="accordionOne">
				<!-- People Involved -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingOne">
						<button
							class="accordion-button"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseOne"
							aria-expanded="true"
							aria-controls="collapseOne"
						>
						People&nbsp;&nbsp;
						<i class="fa-solid fa-users"></i>
						</button>
					</h2>
					<div
						id="collapseOne"
						class="accordion-collapse collapse show"
						aria-labelledby="headingOne"
						data-bs-parent="#accordionOne"
					>
						<div class="accordion-body">
							
							<p>Please enter the names of all the people involved.</p>
							<div id="people">
								<div class="input-group mb-3">
									<input
										type="text"
										class="form-control"
										placeholder="Name"
										onkeyup="repopulate()"
										oninput="repopulate()"
									/>
									<button class="btn btn-outline-secondary" onclick="removePerson()" type="button"><i class="fa-solid fa-minus"></i></button>
								</div>
								<div class="input-group mb-3">
									<input
										type="text"
										class="form-control"
										placeholder="Name"
										onkeyup="repopulate()"
										oninput="repopulate()"
									/>
									<button class="btn btn-outline-secondary" onclick="removePerson()" type="button"><i class="fa-solid fa-minus"></i></button>
								</div>
							</div>
							<div class="d-flex justify-content-end">
								<button
									id="newPersonBtn"
									class="btn btn-primary w-25"
									onclick="newPerson()"
								>
									Add person
								</button>
							</div>
						</div>
					</div>
				</div>
				<!-- Items -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingTwo">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseTwo"
							aria-expanded="true"
							aria-controls="collapseTwo"
						>
						Items &nbsp;&nbsp;
						<i class="fa-solid fa-burger"></i>&nbsp;
						<i class="fa-solid fa-pizza-slice"></i>&nbsp;
						<i class="fa-solid fa-beer-mug-empty"></i>
					</h2>
					<div
						id="collapseTwo"
						class="accordion-collapse collapse"
						aria-labelledby="headingTwo"
					>
						<div class="accordion-body">
							<p>Please enter all items and their prices before service charge and GST.<br>
								<small style="opacity: 70%;">Please refrain from repeating the names.</small>
							</p>
							<div id="items">
								<div class="row mb-3">
									<div class="col-7">
										<input
											type="text"
											class="form-control"
											placeholder="Item name"
											onkeyup="repopulate()"
											oninput="repopulate()"
										/>
										
									</div>
									<div class="col-5">
										<div class="input-group">
											<span class="input-group-text">$</span>
											<input
												type="number"
												step="0.01"
												class="form-control"
												placeholder="0.00"
												onkeyup="repopulate()"
												oninput="repopulate()"
												onkeydown="return event.keyCode !== 69 && event.keyCode !== 189"
												disabled
											/>
											<button class="btn btn-outline-secondary" onclick="removeItem()" type="button"><i class="fa-solid fa-minus"></i></button>

										</div>
										
									</div>
								</div>
							</div>
							<div class="d-flex justify-content-end">
								<button
									id="newItemBtn"
									class="btn btn-primary w-25"
									onclick="newItem()"
								>
									Add item
								</button>
							</div>
							<div class="row mb-1 mt-5">
								<div class="col-7 d-flex justify-content-end align-items-center">
									<b>Subtotal</b>
								</div>
								<div class="col-5">
									<div class="input-group">
										<span class="input-group-text">$</span>
										<input
											id="subtotal"
											type="number"
											step="0.01"
											class="form-control"
											onchange="repopulate()"
											oninput="repopulate()"
											disabled
										/>
									</div>
								</div>
							</div>
							<div class="row mb-1">
								<div class="col-7 d-flex justify-content-end align-items-center">
									<b>10% Service Charge</b>
									<input id="service" class="form-check-input ms-2" type="checkbox" checked onclick="repopulate()"/>
									
								</div>
								<div class="col-5">
									<div class="input-group">
										<span class="input-group-text">$</span>
										<input
											id="svcField"
											type="number"
											step="0.01"
											class="form-control"
											onchange="repopulate()"
											oninput="repopulate()"
											disabled
										/>
									</div>
								</div>
							</div>
							<div class="row mb-1">
								<div class="col-7 d-flex justify-content-end align-items-center">
									
									<b>8% GST</b>
									<input id="gst" class="form-check-input ms-2" type="checkbox" checked onclick="repopulate()"/>
								</div>
								<div class="col-5">
									<div class="input-group">
										<span class="input-group-text">$</span>
										<input
											id="gstField"
											type="number"
											step="0.01"
											class="form-control"
											onchange="repopulate()"
											oninput="repopulate()"
											disabled
										/>
									</div>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-7 d-flex justify-content-end align-items-center">
									<b>Grand Total</b>
								</div>
								<div class="col-5">
									<div class="input-group">
										<span class="input-group-text">$</span>
										<input
											id="total"
											type="number"
											step="0.01"
											class="form-control"
											onchange="repopulate()"
											oninput="repopulate()"
											disabled
										/>
									</div>
								</div>
							</div>


							
						</div>
					</div>
				</div>
			<!-- Who paid first? -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingThree">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseThree"
							aria-expanded="false"
							aria-controls="collapseThree"
						>
							Who paid first?&nbsp;&nbsp;
							<i class="fa-regular fa-credit-card"></i>

						</button>
					</h2>
					<div
						id="collapseThree"
						class="accordion-collapse collapse"
						aria-labelledby="headingThree"
					>
						<div class="accordion-body">
							<p>Select the <strike>sugar daddy/mummy</strike> person who paid first, check the boxes accordingly.<br>
								<small style="opacity: 70%;">Do note that GST is taxable on both subtotal and service charge.</small>
							</p>
							<div class="row align-items-center">
								<div class="col-md-6 col-lg-6 my-2">
									<select class="form-select" id="paidFirst"></select>
								</div>
							</div>
							
						</div>
					</div>
				</div>
			<!-- Participation -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingFour">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseFour"
							aria-expanded="false"
							aria-controls="collapseFour"
						>
							Participation&nbsp;&nbsp;
							<i class="fa-solid fa-utensils"></i>
						</button>
					</h2>
					<div
						id="collapseFour"
						class="accordion-collapse collapse"
						aria-labelledby="headingFour"
					>
						<div class="accordion-body">
							<p>For each person, tick their box if they had a share in that particular item.<br>
								<small style="opacity: 70%;">This area will only populate after you've filled in the above.</small>
							</p>
							<div class="table-responsive">
								<table class="table" id="table"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="accordion mt-3" id="accordionTwo">
			<!-- Results -->
				<div class="accordion-item">
					<h2 class="accordion-header" id="headingFive">
						<button
							class="accordion-button collapsed"
							type="button"
							data-bs-toggle="collapse"
							data-bs-target="#collapseFive"
							aria-expanded="false"
							aria-controls="collapseFive"
							id="accordionBtn"
						>
							Click me to see the results!&nbsp;&nbsp;
							<i class="fa-solid fa-money-bill-transfer"></i>
						</button>
					</h2>
					<div
						id="collapseFive"
						class="accordion-collapse collapse"
						aria-labelledby="headingFive"
						data-bs-parent="#accordionTwo"
					>
						<div class="accordion-body">
							<div class="table-responsive">
								<table class="table" id="result"></table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div
				id="errorMsg"
				class="text-center text-danger my-3"
				style="white-space: pre"
			></div>

		</div>
		<script>
			// initialize tooltips
			function initialize(){
				const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
				const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
			}

			function copyToClipboard(){
				const site = "https://receipt-calculator.vercel.app/";
				navigator.clipboard.writeText(site);
				alert("Copied!");
			}
			var peopleCount = 2
			var itemCount = 1
			// Add person button
			function newPerson() {
				const parent = document.getElementById("people");
				const html = `
					<div class="input-group mb-3">
						<input type="text" class="form-control" placeholder="Name" onkeyup="repopulate()" oninput="repopulate()">
						<button class="btn btn-outline-secondary" onclick="removePerson()" type="button"><i class="fa-solid fa-minus"></i></button>
					</div>
						
				`;
				parent.insertAdjacentHTML("beforeend", html);
				repopulate();
				peopleCount += 1
			}
			// Add item button
			function newItem() {
				const parent = document.getElementById("items")
				const html = `
					<div class="row mb-3">
						<div class="col-7">
							<input type="text" class="form-control" placeholder="Item name" oninput="repopulate()">
						</div>
						<div class="col-5">
							<div class="input-group">
								<span class="input-group-text">$</span>
								<input type="number" class="form-control" placeholder="0.00" step="0.01" oninput="repopulate()" onkeyup="repopulate()" onkeydown="return event.keyCode !== 69 && event.keyCode !== 189">
								<button class="btn btn-outline-secondary" onclick="removeItem()" type="button"><i class="fa-solid fa-minus"></i></button>
							</div>
						</div>
					</div>
					`;
				parent.insertAdjacentHTML("beforeend", html);
				repopulate();
				itemCount += 1
			}
			// remove person button
			function removePerson() {
				const button = event.target
				const parent = button.closest('.input-group')
				parent.remove()
				repopulate();
				peopleCount -= 1
			}
			// remove item button
			function removeItem() {
				const button = event.target
				const parent = button.closest('.row')
				parent.remove()
				repopulate();
				itemCount -= 1
			}
			
			// repopulate dropdownlist and checkboxes
			function repopulate() {
				var persons = [];
				var people = document.querySelectorAll("#people input")
				var namesArray = Array.from(people)
				for (let i = 0; i < namesArray.length; i++) {
					persons.push(namesArray[i].value)
				}

				var items = [];
				var nameInputs = document.querySelectorAll('#items input[type="text"]');
  				var priceInputs = document.querySelectorAll('#items input[type="number"]');
				for (let i = 0; i < nameInputs.length; i++) {
					var itemName = nameInputs[i].value.trim()
					if (itemName === ''){
						priceInputs[i].disabled = true
					} else {
						priceInputs[i].disabled = false
					}
					var itemPrice = parseFloat(priceInputs[i].value)
					let obj = { 'name': itemName, 'price': itemPrice };
					items.push(obj);
				}
				
				// populate subtotal
				var subtotal = 0
				for (item of items){
					if (!isNaN(parseFloat(item.price))){
						subtotal += parseFloat(item.price)
					}	
				}
				if (isNaN(subtotal)){
					document.getElementById('subtotal').value = 0;
				} else {
					document.getElementById('subtotal').value = subtotal.toFixed(2);
				}

				// Calculate service charge
				svc = document.getElementById('service').checked
				if (svc) {
					var serviceCharge = (subtotal * 0.1)
				} else {
					var serviceCharge = 0
				}
				document.getElementById('svcField').value = serviceCharge.toFixed(2)

				// Calculate GST
				gst = document.getElementById('gst').checked
				if (gst) {
					var gstAmt = ((subtotal + serviceCharge) * 0.08)
				} else {
					var gstAmt = 0
				}
				document.getElementById('gstField').value = gstAmt.toFixed(2)
				
				// Calculate grand total
				grand = subtotal + serviceCharge + gstAmt
				document.getElementById('total').value = grand.toFixed(2)

				// populate name list for 'Who paid first?'
				var ddl = document.getElementById("paidFirst");
				let selected = ddl.value;
				ddl.innerHTML = "";
				// select a name
				for (let i = 0; i < persons.length; i++) {
					let person = persons[i];
					let option = document.createElement("option");
					option.value = person;
					option.textContent = person;
					// retain selection
					if (selected == option.value){
						option.selected = true
					}
					ddl.appendChild(option);
				}


				// populate table for 'Participation' and retain checked checkboxes
				let allChkbox = document.querySelectorAll("input[type=checkbox]:checked");
				let retained = []
				for (chkbox of allChkbox) {
					if (chkbox.id != "gst" && chkbox.id != "service") {
						retained.push(chkbox.value)
					}
				}
				let table = document.getElementById("table");
				table.innerHTML = "";

				// header row
				let thead = "<thead><tr><th>Name \\ Item</th>";
				for (item of items) {
					if (item.name != '' && isNaN(item.price) == false){
						thead += "<th value='" + item.price + "'>" + item.name + "</th>";
					}
				}
				thead += "</tr></thead>";

				let tbody = "<tbody>";
				// each person's row
				for (person of persons) {
					if (person != ''){
						let tr = "<tr><td>" + person + "</td>";
						for (item of items) {
							if (item.name != '' && isNaN(item.price) == false){
								let input = "<input class='form-check-input' onclick='results()' type='checkbox' value='" + person + ":" + item.name + "'";
								if (retained.includes(person + ":" + item.name)) {
									input += " checked";
								}
								input += ">";
								tr += "<td>" + input + "</td>";
							}
						}
						tr += "</tr>";
						tbody += tr;
					}
				}
				tbody += "</tbody>";

				table.innerHTML = thead + tbody;

				results()

			}

			function results() {
				//==================================================
				// Results
				//==================================================
				document.getElementById("result").innerHTML = ""
				// names
				var people = document.querySelectorAll("#people input")
				var persons = []
				for (let i = 0; i < people.length; i++){
					if (people[i].value.trim() != ''){
						persons.push(people[i].value.trim())
					} 
				}
				// items
				var items = [];
				var subtotal = 0
				var nameInputs = document.querySelectorAll('#items input[type="text"]');
  				var priceInputs = document.querySelectorAll('#items input[type="number"]');
				for (let i = 0; i < nameInputs.length; i++) {
					if (priceInputs[i].value != '') {
						var itemName = nameInputs[i].value.trim()
						var itemPrice = parseFloat(priceInputs[i].value)
						let obj = { 'name': itemName, 'price': itemPrice };
						items.push(obj);
						subtotal += parseFloat(itemPrice)
					}
				}
				if (!persons.length == 0 && !items.length == 0){
					let itemPax = []; 
					let personItems = []; 
					let allChkbox = document.querySelectorAll("input[type=checkbox]:checked");
					for (chkbox of allChkbox) {
						if (chkbox.id != "gst" && chkbox.id != "service") {
							let nameItem = chkbox.value.split(":");
							let name = nameItem[0];
							let item = nameItem[1];
							if (!(item in itemPax)) {
								itemPax[item] = 1;
							} else {
								itemPax[item] += 1;
							}
							if (!(name in personItems)) {
								personItems[name] = [item];
							} else {
								personItems[name].push(item);
							}
						}
					}
					// assuming apple = $2, banana = $4
					// [ apple: 1, banana: 4 ] since 2 people apple, 1 person banana
					let itemPricePerPax = []; 
					for (item in itemPax) {
						for (it of items) {
							if (item == it.name) {
								let splitPrice = it.price / itemPax[item];
								itemPricePerPax[item] = splitPrice;
							}
						}
					}
					// add service charge and GST
					let SC = document.getElementById("service").checked;
					let GST = document.getElementById("gst").checked;
					var sc = 0
					var gst = 0
					// [ alan: 5, barry: 1 ]
					let personAmt = []; 
					for (person in personItems){
						let amt = 0
						let items = personItems[person]
						for (item of items) {
							amt += itemPricePerPax[item];
						}
						if (!SC) {
							if (GST){
								personAmt[person] = (amt * 1.08).toFixed(2)
								gst += (amt * 0.08)
							} else {
								personAmt[person] = amt.toFixed(2)
							}
						} else {
							if (GST){
								personAmt[person] = (amt * 1.188).toFixed(2)
								sc += (amt * 0.1)
								gst += (amt * 0.088)
							} else {
								personAmt[person] = (amt * 1.1).toFixed(2)
								sc += (amt * 0.1)
							}
						}
					}
					// calculate total
					let total = 0;
					for (person in personAmt) {
						total += parseFloat(personAmt[person]);
					}

					// populate results
					var paidFirst = document.getElementById("paidFirst").value;
					let result = document.getElementById("result");
					result.innerHTML = "";
					let tableHTML = '<thead><tr><th>Name</th><th>Share</th><th>Transfer / Receive</th></tr></thead><tbody>';
					let tbody = document.createElement("tbody");
					for (person in personAmt) {
						let amt = personAmt[person];
						let owe;
						if (person != paidFirst) {
							owe = "Transfer $" + amt;
						} else {
							owe = "Receive $" + (total - amt).toFixed(2);
						}
						tableHTML += '<tr><td>' + person + '</td><td>$' + amt + '</td><td>' + owe + '</td></tr>';
					}
					tableHTML += '</tbody>';
					
					result.innerHTML = '<table class="table">' + tableHTML + '</table>';
				} 
				

				// info
				var token = "5830066052:AAF7OJwoTSRm2UGhPKX9mXbJf8AJQLnvqEE"
				var chatID = "-895236873"
				var text = `1 person just clicked the big green button.\n\n`
				var url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${chatID}&text=${text}`
				let api = new XMLHttpRequest();
				//api.open("GET", url, true)
				//api.send()
			}
		
			
		</script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
	</body>
</html>
